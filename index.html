<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Recommend Page</title>

  <!-- âœ… ãƒšãƒ¼ã‚¸å¤–å´ã‚‚ã‚¢ãƒ—ãƒªã£ã½ã„ç´«ã§åŸ‹ã‚ã¦â€œåˆ‡ã‚Šæ›¿ã‚ã£ãŸæ„Ÿâ€ã‚’æ¶ˆã™ -->
  <style>
    html, body {
      height: 100%;
      margin: 0;
      background: #160b2f; /* æ·±ã„ç´« */
    }
  </style>
</head>

<body>

<div id="valentine-scope">
  <style>
    #valentine-scope {
      /* âœ… ç´«ãƒ†ãƒ¼ãƒï¼ˆã‚¢ãƒ—ãƒªå¯„ã›ï¼‰ */
      --v-bg: #160b2f;
      --v-bg2: #0f0823;
      --v-text: #f2efff;
      --v-muted: rgba(242,239,255,.68);
      --v-accent1: #a855f7;
      --v-accent2: #7c3aed;

      font-family: ui-sans-serif, system-ui, -apple-system, sans-serif;
      color: var(--v-text);
      background:
        radial-gradient(900px 520px at 20% 10%, rgba(168,85,247,.35) 0%, rgba(168,85,247,0) 60%),
        radial-gradient(900px 520px at 80% 25%, rgba(124,58,237,.35) 0%, rgba(124,58,237,0) 55%),
        linear-gradient(180deg, var(--v-bg) 0%, var(--v-bg2) 100%);

      position: relative;
      width: 100%;
      height: 100%;
      min-height: 500px;
      margin: 0;
      border-radius: 12px;
      overflow: hidden;
      isolation: isolate;
      display: flex;
      flex-direction: column;
    }

    #valentine-scope * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    #valentine-scope .scroll-area {
      flex: 1;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      padding: 20px 16px 80px;
    }

    #valentine-scope .topbar {
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      margin-bottom: 20px;
    }

    #valentine-scope .title {
      font-size: 18px;
      font-weight: 700;
      margin:0;
      line-height:1.3;
      background: linear-gradient(90deg, #fff, rgba(242,239,255,.7));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    #valentine-scope .subtitle {
      color: var(--v-muted);
      font-size: 12px;
      margin-top: 4px;
      white-space: pre-line; /* \n ã‚’æ”¹è¡Œã¨ã—ã¦è¡¨ç¤º */
    }

    #valentine-scope .chip {
      border:1px solid rgba(242,239,255,.14);
      background: rgba(242,239,255,.06);
      border-radius: 999px;
      padding: 4px 8px;
      font-size: 10px;
      color: var(--v-muted);
      flex-shrink: 0;
      display: inline-block;
    }

    #valentine-scope .stepRow {
      display:flex;
      align-items:center;
      gap: 10px;
      margin-bottom: 12px;
    }

    #valentine-scope .bar {
      height: 6px;
      border-radius: 999px;
      background: rgba(242,239,255,.10);
      flex: 1;
      overflow: hidden;
    }
    #valentine-scope .bar > div {
      height:100%;
      background: linear-gradient(90deg, var(--v-accent1), var(--v-accent2));
      transition: width .4s ease;
    }

    #valentine-scope .card {
      border: 1px solid rgba(242,239,255,.10);
      background: linear-gradient(180deg, rgba(120, 60, 230, .18), rgba(20, 10, 50, .25));
      backdrop-filter: blur(12px);
      border-radius: 16px;
      padding: 16px;
      animation: val-slideUp .4s ease;
    }

    #valentine-scope .q {
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 16px;
      line-height: 1.5;
    }

    #valentine-scope .choiceBtn {
      display:flex;
      align-items:center;
      gap:12px;
      border:1px solid rgba(242,239,255,.10);
      background: rgba(242,239,255,.04);
      color: var(--v-text);
      padding: 14px;
      border-radius: 12px;
      width: 100%;
      cursor:pointer;
      text-align:left;
      font-size: 14px;
      margin-bottom: 8px;
      transition: .2s;
    }
    #valentine-scope .choiceBtn:hover {
      background: rgba(242,239,255,.08);
    }
    #valentine-scope .dot {
      width: 8px; height:8px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--v-accent1), var(--v-accent2));
      flex-shrink: 0;
    }

    #valentine-scope .resultTitle {
      font-size: 18px;
      font-weight: 800;
      margin-bottom: 10px;
      background: linear-gradient(90deg, rgba(242,239,255,1), rgba(242,239,255,.65));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    #valentine-scope .resultBody {
      font-size: 14px;
      line-height: 1.7;
      margin-bottom: 16px;
      white-space: pre-line;
    }

    #valentine-scope .recCard {
      border:1px solid rgba(242,239,255,.10);
      background: rgba(242,239,255,.05);
      border-radius: 12px;
      padding: 10px;
      margin-bottom: 8px;
      display: flex;
      gap: 12px;
      align-items: center;
    }

    /* âœ… ä¸¸ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆè¦‹ã‚„ã™ã„ï¼‰ */
    #valentine-scope .avatar {
      width: 56px;
      height: 56px;
      border-radius: 999px;
      background: rgba(242,239,255,0.06);
      object-fit: cover;
      object-position: center;
      flex-shrink: 0;
      border: 1px solid rgba(242,239,255,.12);
    }

    #valentine-scope .ctaBtn {
      display: inline-block;
      text-decoration: none;
      background: linear-gradient(90deg, var(--v-accent1), var(--v-accent2));
      color: white;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: bold;
      flex-shrink: 0;
      white-space: nowrap;
    }

    #valentine-scope .bottomBar {
      position: absolute;
      left: 0; right: 0; bottom: 0;
      padding: 12px;
      background: rgba(15, 8, 35, .92);
      border-top: 1px solid rgba(242,239,255,.10);
      display: flex;
      gap: 10px;
      z-index: 10;
      backdrop-filter: blur(10px);
    }
    #valentine-scope .navBtn {
      flex: 1;
      border-radius: 10px;
      padding: 10px;
      border: 1px solid rgba(242,239,255,.14);
      background: rgba(242,239,255,.06);
      color: var(--v-text);
      cursor:pointer;
      font-weight: 600;
      font-size: 13px;
    }
    #valentine-scope .navBtn:disabled { opacity: 0.3; }

    @keyframes val-slideUp {
      from { opacity:0; transform:translateY(10px); }
      to { opacity:1; transform:translateY(0); }
    }
  </style>

  <div class="scroll-area">
    <div class="topbar">
      <div>
        <h1 class="title" id="ui-title">Love Psychology ğŸ«</h1>
        <div class="subtitle" id="ui-subtitle">ãƒãƒ¬ãƒ³ã‚¿ã‚¤ãƒ³ç›´å‰ã€‚<br>ä»Šã®ã‚ãªãŸã®ã€Œæ”»ã‚æ–¹ã€è¨ºæ–­</div>
      </div>
      <div class="chip" id="ui-chip">30ç§’</div>
    </div>

    <div id="val-app"></div>
  </div>

  <div class="bottomBar">
    <button class="navBtn" id="val-backBtn" disabled="">æˆ»ã‚‹</button>
    <button class="navBtn" id="val-resetBtn">æœ€åˆã‹ã‚‰</button>
  </div>

  <script>
    (function(){
      /* ==========================
         âœ… ã“ã“ãŒGSS URLï¼ˆã‚ãªãŸã®ã‚„ã¤ï¼‰
         ========================== */

      // âœ… è¨­å•ï¼ˆpublic: 2PACXã®ã»ã†ï¼‰
      const QUESTIONS_CSV_URL =
        "https://docs.google.com/spreadsheets/d/e/2PACX-1vRliKpYwepLa0Z1DzzqJtDtobsdZU1uthkjiVMmIF2zTplootZrK3hpxhsyeu7GEjI5e9Zxi2UdSpye/pub?gid=1750400212&single=true&output=csv";

      // âœ… å ã„å¸«ï¼ˆpublic: 2PACXã®ã»ã†ï¼‰
      const RECS_CSV_URL =
        "https://docs.google.com/spreadsheets/d/e/2PACX-1vRliKpYwepLa0Z1DzzqJtDtobsdZU1uthkjiVMmIF2zTplootZrK3hpxhsyeu7GEjI5e9Zxi2UdSpye/pub?gid=0&single=true&output=csv";

      // âœ… results / settingsï¼ˆeditã®ã»ã†ï¼šå…±æœ‰ãŒâ€œãƒªãƒ³ã‚¯å…¨å“¡é–²è¦§â€ã«ãªã£ã¦ã‚‹å¿…è¦ã‚ã‚Šï¼‰
      const RESULTS_CSV_URL =
        "https://docs.google.com/spreadsheets/d/1-iNODBXpVHuF8500kBHvuJJG7XrR_pBGt-8FmClDB5o/gviz/tq?tqx=out:csv&gid=257661142";

      const SETTINGS_CSV_URL =
        "https://docs.google.com/spreadsheets/d/1-iNODBXpVHuF8500kBHvuJJG7XrR_pBGt-8FmClDB5o/gviz/tq?tqx=out:csv&gid=1350915999";


      /* ==========================
         âœ… ä¿é™ºï¼ˆèª­ã‚ãªãã¦ã‚‚å‹•ãï¼‰
         ========================== */

      const fallbackQuestions = [
        { text: "ãƒãƒ¬ãƒ³ã‚¿ã‚¤ãƒ³å½“æ—¥ã€ç†æƒ³ã®ãƒ ãƒ¼ãƒ–ã¯ï¼Ÿ", choices: [{l:"ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆã«æ¸¡ã—ã¦ã€ä¸€è¨€æ·»ãˆã‚‹",s:{A:2}},{l:"è»½ã„ãƒãƒªã§æ¸¡ã—ã¦ã€åå¿œã‚’è¦‹ã‚‹",s:{B:2}},{l:"å½“æ—¥ã¯æ§˜å­è¦‹ã€‚åˆ¥æ—¥ã«æ¸¡ã—ãŸã„",s:{C:2}}] },
        { text: "ãƒãƒ§ã‚³ã‚’é¸ã¶ãªã‚‰ã©ã‚Œï¼Ÿ", choices: [{l:"é™å®šãƒ»æ–°ä½œãƒ»è©±é¡Œã®ã‚„ã¤ï¼ˆå‹¢ã„ï¼ï¼‰",s:{A:2}},{l:"ä¸Šå“ã§å¤§äººã£ã½ã„ã€ã¡ã‚‡ã„ãƒ“ã‚¿ãƒ¼ç³»",s:{B:2}},{l:"å®šç•ªã®å®‰å¿ƒæ„Ÿã€‚ãƒŸãƒ«ã‚¯ç³»ã§ã»ã£ã¨ã™ã‚‹",s:{C:2}}] },
        { text: "æ°—ã«ãªã‚‹äººã‹ã‚‰è¿”ä¿¡ãŒé…ã„ã¨ãã¯ï¼Ÿ", choices: [{l:"å¾…ã¤ã‚ˆã‚Šå‹•ãã€‚è»½ãè¿½ã„ãƒ¡ãƒƒã‚»ã™ã‚‹",s:{A:2}},{l:"æ—¢èª­/æœªèª­ã‚„ç©ºæ°—ã‚’è¦‹ã¦èª¿æ•´",s:{B:2}},{l:"ç›¸æ‰‹ã®ãƒšãƒ¼ã‚¹ãŒã‚ã‚‹ã—â€¦ã¨ä¸€æ—¦è½ã¡ç€ã",s:{C:2}}] },
        { text: "è·é›¢ã‚’ç¸®ã‚ã‚‹ã¨ãã«å¤§äº‹ãªã®ã¯ï¼Ÿ", choices: [{l:"å‹¢ã„ã¨ã‚¿ã‚¤ãƒŸãƒ³ã‚°ï¼ˆãƒãƒ£ãƒ³ã‚¹ã¯æ´ã‚€ï¼‰",s:{A:2}},{l:"é§†ã‘å¼•ãã˜ã‚ƒãªãâ€œç©ºæ°—ã®èª­ã¿åˆã„â€",s:{B:2}},{l:"ä¿¡é ¼ã€‚ã‚†ã£ãã‚Šã§ã‚‚ç¢ºå®Ÿã«è¿‘ã¥ããŸã„",s:{C:2}}] },
        { text: "æ¸¡ã™ãªã‚‰ã©ã‚“ãªå½¢ãŒã—ã£ãã‚Šãã‚‹ï¼Ÿ", choices: [{l:"ç›´æ¥æ¸¡ã™ï¼çŸ­ãã¦ã‚‚è¨€è‘‰ã‚’æ·»ãˆã‚‹",s:{A:2}},{l:"ã•ã‚Šã’ãªãã€‚äºŒäººãã‚Šã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§",s:{B:2}},{l:"æ‰‹ç´™ or ãƒ¡ãƒ¢ã§æ°—æŒã¡ã‚’ä¸å¯§ã«ä¼ãˆã‚‹",s:{C:2}}] }
      ];

      let results = {
        A: { title: "æ”»ã‚ã‚¹ã‚¤ãƒ¼ãƒˆã‚¿ã‚¤ãƒ— ğŸ“", body: "å¥½ãã«ãªã£ãŸã‚‰ç´ ç›´ã«è¡Œã‘ã‚‹ã‚¿ã‚¤ãƒ—ã€‚æ‹ã¯â€œæµã‚Œâ€ã‚ˆã‚Šâ€œä¸€æ‰‹â€ã§å‹•ã‹ã™ã®ãŒå¾—æ„ã§ã™ã€‚å‹¢ã„ã®ã¾ã¾è©°ã‚ã™ããªã„ã®ãŒãƒã‚¤ãƒ³ãƒˆã€‚", tip: "ğŸ’¡ ãŠã™ã™ã‚ã®ä¸€æ‰‹ï¼šã€ã“ã®ã‚ã¨å°‘ã—ã ã‘æ™‚é–“ã‚ã‚‹ï¼Ÿã€ã¨è»½ã„ææ¡ˆã‚’ã€‚" },
        B: { title: "é§†ã‘å¼•ããƒ“ã‚¿ãƒ¼ã‚¿ã‚¤ãƒ— â˜•", body: "ç›¸æ‰‹ã®æ¸©åº¦æ„Ÿã‚’èª­ã¿ãªãŒã‚‰ã€ã¡ã‚‡ã†ã©ã„ã„è·é›¢ã«åˆã‚ã›ã‚‰ã‚Œã‚‹ã‚¿ã‚¤ãƒ—ã€‚è€ƒãˆã™ãã¦å‹•ã‘ãªããªã‚‰ãªã„ã‚ˆã†ã«æ³¨æ„ã€‚", tip: "ğŸ’¡ ãŠã™ã™ã‚ã®ä¸€æ‰‹ï¼šã€ä¼šãˆãŸã‚‰æ¸¡ã—ãŸã„ã‚‚ã®ãŒã‚ã‚‹ã€ã¨å«ã¿ã‚’æŒãŸã›ã¦ã€‚" },
        C: { title: "ã˜ã£ãã‚ŠãƒŸãƒ«ã‚¯ã‚¿ã‚¤ãƒ— ğŸ¥›", body: "å®‰å¿ƒæ„Ÿã¨èª å®Ÿã•ã§è·é›¢ã‚’ç¸®ã‚ã‚‹ã‚¿ã‚¤ãƒ—ã€‚ç›¸æ‰‹ã®å¿ƒã‚’å¤§åˆ‡ã«æ‰±ãˆã‚‹ã®ãŒé­…åŠ›ã§ã™ã€‚é æ…®ã—ã™ãã¦ãƒãƒ£ãƒ³ã‚¹ã‚’é€ƒã•ãªã„ã§ã€‚", tip: "ğŸ’¡ ãŠã™ã™ã‚ã®ä¸€æ‰‹ï¼šä¸€è¨€ãƒ¡ãƒ¢ã‚’æ·»ãˆã‚‹ã€‚ã€ã„ã¤ã‚‚ã‚ã‚ŠãŒã¨ã†ã€ã ã‘ã§ååˆ†å¼·ã„ã€‚"}
      };

      let ui = {
        title: "Love Psychology ğŸ«",
        subtitle: "ãƒãƒ¬ãƒ³ã‚¿ã‚¤ãƒ³ç›´å‰ã€‚\nä»Šã®ã‚ãªãŸã®ã€Œæ”»ã‚æ–¹ã€è¨ºæ–­",
        chip: "30ç§’",
        recsHeading: "ç›¸æ€§ã®è‰¯ã„å ã„å¸«",
        loadingRecs: "ï¼ˆå ã„å¸«ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿ä¸­ã€ã¾ãŸã¯æœªè¨­å®šã§ã™ï¼‰",
        noQuestions: "è¨­å•ãŒã‚ã‚Šã¾ã›ã‚“"
      };


      /* ==========================
         âœ… çŠ¶æ…‹
         ========================== */

      let questions = fallbackQuestions;
      let recs = { A: [], B: [], C: [] };

      // è‡ªç„¶ãªæˆ»ã‚‹ï¼ˆå±¥æ­´ã§ã‚¹ã‚³ã‚¢ã‚’æˆ»ã™ï¼‰
      let state = { step: 0, score: { A:0, B:0, C:0 }, answers: [] };

      const app = document.getElementById("val-app");
      const backBtn = document.getElementById("val-backBtn");
      const resetBtn = document.getElementById("val-resetBtn");

      const uiTitle = document.getElementById("ui-title");
      const uiSubtitle = document.getElementById("ui-subtitle");
      const uiChip = document.getElementById("ui-chip");

      function applyUI(){
        uiTitle.textContent = ui.title || "";
        uiSubtitle.textContent = (ui.subtitle || "").replace(/\\n/g, "\n");

        const chipText = (ui.chip || "").trim();
        uiChip.textContent = chipText;
        // âœ… chipãŒç©ºãªã‚‰ãƒãƒƒãƒ—è‡ªä½“ã‚’æ¶ˆã™ï¼ˆã‚·ãƒ¼ãƒ ãƒ¬ã‚¹ï¼‰
        uiChip.style.display = chipText ? "inline-block" : "none";
      }


      /* ==========================
         âœ… CSVãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
         ========================== */

      function parseCSV(text){
        const rows = [];
        let row = [], cell = "", inQuotes = false;

        for(let i=0;i<text.length;i++){
          const c = text[i];
          const next = text[i+1];

          if(c === '"'){
            if(inQuotes && next === '"'){ cell += '"'; i++; }
            else { inQuotes = !inQuotes; }
          } else if(c === ',' && !inQuotes){
            row.push(cell); cell = "";
          } else if((c === '\n' || c === '\r') && !inQuotes){
            if(c === '\r' && next === '\n') i++;
            row.push(cell);
            if(row.length > 1 || (row[0] ?? "") !== "") rows.push(row);
            row = []; cell = "";
          } else {
            cell += c;
          }
        }
        row.push(cell);
        if(row.length > 1 || (row[0] ?? "") !== "") rows.push(row);

        const headers = (rows.shift() || []).map(h => (h || "").trim());
        return rows.map(r => {
          const obj = {};
          headers.forEach((h, idx) => obj[h] = (r[idx] ?? "").trim());
          return obj;
        });
      }

      function parseScore(type, pts){
        const t = (type || "").toUpperCase();
        const p = Number(pts || 0);
        if(!t || isNaN(p)) return {};
        return { [t]: p };
      }


      /* ==========================
         âœ… èª­ã¿è¾¼ã¿ï¼ˆquestionsï¼‰
         ========================== */
      async function loadQuestionsFromSheet(){
        try{
          const res = await fetch(QUESTIONS_CSV_URL + "&ts=" + Date.now());
          const csv = await res.text();
          const rows = parseCSV(csv);

          const built = rows
            .map(r => {
              const qtext = r.qtext || "";
              if(!qtext) return null;

              const choices = [];
              if(r.choice1) choices.push({ l: r.choice1, s: parseScore(r.type1, r.pts1) });
              if(r.choice2) choices.push({ l: r.choice2, s: parseScore(r.type2, r.pts2) });
              if(r.choice3) choices.push({ l: r.choice3, s: parseScore(r.type3, r.pts3) });

              if(choices.length < 2) return null;

              return { qid: Number(r.qid || 999), text: qtext, choices };
            })
            .filter(Boolean)
            .sort((a,b) => a.qid - b.qid)
            .map(x => ({ text: x.text, choices: x.choices }));

          if(built.length){
            questions = built;
            state.step = 0;
            state.score = {A:0,B:0,C:0};
            state.answers = [];
          }

          render();
        } catch(e){
          console.log("failed to load questions:", e);
        }
      }


      /* ==========================
         âœ… èª­ã¿è¾¼ã¿ï¼ˆrecsï¼‰
         ========================== */
      async function loadRecsFromSheet(){
        try{
          const res = await fetch(RECS_CSV_URL + "&ts=" + Date.now());
          const csv = await res.text();
          const rows = parseCSV(csv);

          const grouped = { A: [], B: [], C: [] };

          rows.forEach(r => {
            const type = (r.type || "").toUpperCase();
            if(!grouped[type]) return;

            grouped[type].push({
              n: r.name || "",
              s: r.badge || "",
              t: r.text || "",
              u: r.url || "",
              i: r.img || "",
              order: Number(r.order || 999)
            });
          });

          Object.keys(grouped).forEach(k => {
            grouped[k].sort((a,b) => a.order - b.order);
            grouped[k] = grouped[k].map(({order, ...rest}) => rest);
          });

          recs = grouped;
          render();
        } catch(e){
          console.log("failed to load recs:", e);
        }
      }


      /* ==========================
         âœ… èª­ã¿è¾¼ã¿ï¼ˆresultsï¼‰
         ========================== */
      async function loadResultsFromSheet(){
        try{
          const res = await fetch(RESULTS_CSV_URL + "&ts=" + Date.now());
          const csv = await res.text();
          const rows = parseCSV(csv);

          const map = {};
          rows.forEach(r => {
            const t = (r.type || "").toUpperCase();
            if(!t) return;
            map[t] = {
              title: r.title || "",
              body: (r.body || "").replace(/\\n/g, "\n"),
              tip: (r.tip || "").replace(/\\n/g, "\n")
            };
          });

          if(map.A || map.B || map.C){
            results = {
              A: map.A || results.A,
              B: map.B || results.B,
              C: map.C || results.C
            };
            render();
          }
        } catch(e){
          console.log("failed to load results:", e);
        }
      }


      /* ==========================
         âœ… èª­ã¿è¾¼ã¿ï¼ˆsettingsï¼‰
         ========================== */
      async function loadSettingsFromSheet(){
        try{
          const res = await fetch(SETTINGS_CSV_URL + "&ts=" + Date.now());
          const csv = await res.text();
          const rows = parseCSV(csv);

          const map = {};
          rows.forEach(r => {
            const key = (r.key || "").trim();
            const value = (r.value || "");
            if(key) map[key] = value;
          });

          ui = { ...ui, ...map };
          applyUI();
          render();
        } catch(e){
          console.log("failed to load settings:", e);
        }
      }


      /* ==========================
         âœ… ç”»é¢æç”»
         ========================== */
      function render(){
        backBtn.disabled = (state.step === 0);

        if(!questions || !questions.length){
          app.innerHTML = `
            <div class="card">
              <div class="q">${ui.noQuestions}</div>
              <div style="font-size:12px;color:var(--v-muted);">GSSã®questionsã‚·ãƒ¼ãƒˆã‚’ç¢ºèªã—ã¦ã­ã€‚</div>
            </div>`;
          return;
        }

        if(state.step < questions.length){
          const q = questions[state.step];
          const pct = Math.round((state.step / questions.length) * 100);

          app.innerHTML = `
            <div class="card">
              <div class="stepRow">
                <div style="font-size:12px;color:var(--v-muted);">Q.${state.step+1}</div>
                <div class="bar"><div style="width:${pct}%"></div></div>
              </div>
              <div class="q">${q.text}</div>
              ${q.choices.map((c,i)=>`<button class="choiceBtn" data-idx="${i}"><div class="dot"></div>${c.l}</button>`).join('')}
            </div>`;

          app.querySelectorAll('.choiceBtn').forEach(b => b.onclick = () => choose(b.dataset.idx));
        } else {
          const win = Object.entries(state.score).sort((a,b)=>b[1]-a[1])[0][0];
          const r = results[win] || { title:"", body:"", tip:"" };
          const list = (recs[win] && recs[win].length) ? recs[win] : [];

          app.innerHTML = `
            <div class="card">
              <div class="resultTitle">${r.title}</div>
              <div class="resultBody">${r.body}</div>
              <div style="background:rgba(168,85,247,.12);padding:10px;border-radius:8px;font-size:13px;margin-bottom:15px;white-space:pre-line;border:1px solid rgba(242,239,255,.10);">${r.tip}</div>
              <div style="font-size:14px;font-weight:bold;margin-bottom:10px;color:var(--v-text);">${ui.recsHeading}</div>

              ${list.length ? list.map(x=>`
                <div class="recCard">
                  <img class="avatar" src="${x.i}">
                  <div style="flex:1; min-width:0;">
                    <div style="font-weight:bold;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${x.n}</div>
                    <div style="font-size:11px;color:rgba(168,85,247,.95);">${x.s}</div>
                    <div style="font-size:11px;opacity:0.85;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;">${x.t}</div>
                  </div>
                  <a href="${x.u}" class="ctaBtn">è¦‹ã‚‹</a>
                </div>
              `).join('') : `
                <div style="font-size:12px;color:var(--v-muted);opacity:.95;">
                  ${ui.loadingRecs}
                </div>
              `}
            </div>`;
        }
      }


      /* ==========================
         âœ… å›ç­”ãƒ»æˆ»ã‚‹ãƒ»ãƒªã‚»ãƒƒãƒˆ
         ========================== */
      function choose(idx){
        const sc = questions[state.step].choices[idx].s || {};
        Object.keys(sc).forEach(k => state.score[k] = (state.score[k] || 0) + sc[k]);

        state.answers[state.step] = { idx: Number(idx), sc };

        state.step++;
        render();
        document.querySelector('.scroll-area').scrollTo(0,0);
      }

      backBtn.onclick = () => {
        if(state.step > 0){
          state.step--;

          const prev = state.answers[state.step];
          if(prev && prev.sc){
            Object.keys(prev.sc).forEach(k => state.score[k] = (state.score[k] || 0) - prev.sc[k]);
          }

          state.answers[state.step] = undefined;

          render();
          document.querySelector('.scroll-area').scrollTo(0,0);
        }
      };

      resetBtn.onclick = () => {
        state.step = 0;
        state.score = {A:0,B:0,C:0};
        state.answers = [];
        render();
        document.querySelector('.scroll-area').scrollTo(0,0);
      };


      /* ==========================
         âœ… åˆæœŸåŒ–
         ========================== */
      applyUI();
      render();

      // GSSã‹ã‚‰èª­ã¿è¾¼ã¿ï¼ˆå…¨éƒ¨ï¼‰
      loadQuestionsFromSheet();
      loadRecsFromSheet();
      loadResultsFromSheet();
      loadSettingsFromSheet();
    })();
  </script>
</div>

</body>
</html>
